{"version":3,"file":"next-sanity.cjs.development.js","sources":["../src/client.ts","../src/imageUrlBuilder.ts","../src/aborter.ts","../src/currentUser.ts","../src/useSubscription.ts","../src/portableText.tsx"],"sourcesContent":["import picoSanity from 'picosanity'\nimport {ClientConfig} from './types'\n\nexport function createClient(config: ClientConfig) {\n  return picoSanity(config)\n}\n","import getImageUrlBuilder from '@sanity/image-url'\nimport {ProjectConfig} from './types'\n\nexport function createImageUrlBuilder({projectId, dataset}: ProjectConfig) {\n  return getImageUrlBuilder({projectId, dataset})\n}\n","export interface Aborter {\n  abort(): void\n  signal?: AbortSignal\n}\n\nexport function getAborter(): Aborter {\n  return typeof AbortController === 'undefined'\n    ? {signal: undefined, abort: noop}\n    : new AbortController()\n}\n\nfunction noop() {\n  // intentional noop\n}\n","import {useEffect, useState} from 'react'\nimport {CurrentUser} from './types'\nimport {getAborter, Aborter} from './aborter'\n\nexport function createCurrentUserHook({projectId}: {projectId: string; dataset?: string}) {\n  return () => useCurrentUser(projectId)\n}\n\nexport function getCurrentUser(projectId: string, abort?: Aborter): Promise<CurrentUser | null> {\n  return fetch(`https://${projectId}.api.sanity.io/v1/users/me`, {\n    credentials: 'include',\n    signal: abort?.signal,\n  })\n    .then((res) => res.json())\n    .then((res) => (res?.id ? res : null))\n    .catch((err: Error) => (err.name === 'AbortError' ? null : Promise.reject(err)))\n}\n\nfunction useCurrentUser(projectId: string) {\n  const [data, setUser] = useState<CurrentUser | null>()\n  const [error, setError] = useState<Error>()\n\n  useEffect(() => {\n    const aborter = getAborter()\n    getCurrentUser(projectId, aborter).then(setUser).catch(setError)\n    return () => aborter.abort()\n  }, [projectId])\n\n  return {data, error, loading: data !== null || !error}\n}\n","import {useState} from 'react'\nimport {GroqStore, Subscription} from '@sanity/groq-store'\nimport {useDeepCompareEffectNoCheck as useDeepCompareEffect} from 'use-deep-compare-effect'\nimport {ProjectConfig} from './types'\nimport {getCurrentUser} from './currentUser'\nimport {getAborter} from './aborter'\n\ninterface SubscriptionOptions<R = any> {\n  enabled?: boolean\n  params?: Record<string, unknown>\n  initialData?: R\n}\n\nexport function createPreviewSubscriptionHook({\n  projectId,\n  dataset,\n  documentLimit = 3000,\n}: ProjectConfig & {documentLimit?: number}) {\n  // Only construct/setup the store when `getStore()` is called\n  let store: Promise<GroqStore>\n\n  return function usePreviewSubscription<R = any>(\n    query: string,\n    options: SubscriptionOptions<R> = {}\n  ) {\n    const {params = {}, initialData, enabled} = options\n    return useQuerySubscription<R>({\n      getStore,\n      projectId,\n      query,\n      params,\n      initialData: initialData as any,\n      enabled: enabled ? typeof window !== 'undefined' : false,\n    })\n  }\n\n  function getStore() {\n    if (!store) {\n      store = import('@sanity/groq-store').then(({groqStore}) =>\n        groqStore({\n          projectId,\n          dataset,\n          documentLimit,\n          listen: true,\n          overlayDrafts: true,\n          subscriptionThrottleMs: 10,\n        })\n      )\n    }\n    return store\n  }\n}\n\nfunction useQuerySubscription<R = any>(options: {\n  getStore: () => Promise<GroqStore>\n  projectId: string\n  query: string\n  params: Record<string, unknown>\n  initialData: R\n  enabled: boolean\n}) {\n  const {getStore, projectId, query, params, initialData, enabled = false} = options\n  const [error, setError] = useState<Error>()\n  const [loading, setLoading] = useState(false)\n  const [data, setData] = useState<R>()\n\n  // Use \"deep\" dependency comparison because params are often not _referentially_ equal,\n  // but contains the same shallow properties, eg `{\"slug\": \"some-slug\"}`\n  useDeepCompareEffect(() => {\n    if (!enabled) {\n      return () => {\n        /* intentional noop */\n      }\n    }\n\n    setLoading(true)\n\n    const aborter = getAborter()\n    let subscription: Subscription | undefined\n    getCurrentUser(projectId, aborter)\n      .then((user) => {\n        if (user) {\n          return\n        }\n\n        // eslint-disable-next-line no-console\n        console.warn('Not authenticated - preview not available')\n        throw new Error('Not authenticated - preview not available')\n      })\n      .then(getStore)\n      .then((store) => {\n        subscription = store.subscribe(query, params, (err, result) => {\n          if (err) {\n            setError(err)\n          } else {\n            setData(result)\n          }\n        })\n      })\n      .catch(setError)\n      .finally(() => setLoading(false))\n\n    return () => {\n      if (subscription) {\n        subscription.unsubscribe()\n      }\n\n      aborter.abort()\n    }\n  }, [getStore, query, params, enabled])\n\n  return {\n    data: typeof data === 'undefined' ? initialData : data,\n    loading,\n    error,\n  }\n}\n","import React from 'react'\nimport SanityPortableText, {\n  PortableTextProps,\n  PortableTextSerializers,\n} from '@sanity/block-content-to-react'\nimport {ProjectConfig} from './types'\n\nexport function createPortableTextComponent({\n  projectId,\n  dataset,\n  serializers,\n}: ProjectConfig & {serializers?: PortableTextSerializers}) {\n  return function PortableText(props: PortableTextProps) {\n    return (\n      <SanityPortableText\n        projectId={projectId}\n        dataset={dataset}\n        serializers={serializers}\n        {...props}\n      />\n    )\n  }\n}\n"],"names":["createClient","config","picoSanity","createImageUrlBuilder","projectId","dataset","getImageUrlBuilder","getAborter","AbortController","signal","undefined","abort","noop","createCurrentUserHook","useCurrentUser","getCurrentUser","fetch","credentials","then","res","json","id","catch","err","name","Promise","reject","useState","data","setUser","error","setError","useEffect","aborter","loading","createPreviewSubscriptionHook","documentLimit","store","usePreviewSubscription","query","options","params","initialData","enabled","useQuerySubscription","getStore","window","groqStore","listen","overlayDrafts","subscriptionThrottleMs","setLoading","setData","useDeepCompareEffect","subscription","user","console","warn","Error","subscribe","result","finally","unsubscribe","createPortableTextComponent","serializers","PortableText","props","React","SanityPortableText"],"mappings":"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"}